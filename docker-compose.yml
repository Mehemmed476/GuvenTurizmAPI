version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # 1. SQL SERVER (Veritabanı)
  # ---------------------------------------------------------------------------
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: guven_sql
    restart: always
    environment:
      - ACCEPT_EULA=Y
      # GÜVENLİK NOTU: Bu şifreyi .env dosyasından çekmek daha güvenlidir.
      # Şimdilik buraya çok güçlü bir şifre yazdım.
      - MSSQL_SA_PASSWORD=GuvenTurizmMehemmedElIsi2026!@#!
      - MSSQL_PID=Express
    # volumes: Verilerin kalıcı olması için
    volumes:
      - mssql_data:/var/opt/mssql/data
    # networks: Sadece internal ağa bağlı, dışarıya port vermiyoruz!
    networks:
      - guven-internal-net
    # healthcheck: DB'nin gerçekten hazır olup olmadığını kontrol eder
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'GuvenTurizmMehemmedElIsi2026!@#' -Q 'SELECT 1' || exit 1"]
      interval: 10s
      retries: 5
      start_period: 10s
      timeout: 5s
    # logging: Logların diski doldurmasını engeller
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # 2. BACKEND API
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: guven_api
    restart: always
    environment:
      # Server=sqlserver kısmı, servis adıdır. Docker DNS bunu çözer.
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=GuvenTurizmDB;User Id=sa;Password=GuvenTurizmMehemmedElIsi2026!@#;TrustServerCertificate=True;
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
    # ports: 
    # Sadece 127.0.0.1'e açıyoruz. Böylece Nginx erişebilir ama
    # dışarıdan IP:5072 yazan biri erişemez. Ekstra güvenlik!
    ports:
      - "127.0.0.1:5072:8080"
    depends_on:
      sqlserver:
        condition: service_healthy # DB tamamen hazır olmadan API başlamaz
    volumes:
      - ./App_Data:/app/App_Data
    networks:
      - guven-internal-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ---------------------------------------------------------------------------
# NETWORK VE VOLUME TANIMLARI
# ---------------------------------------------------------------------------
networks:
  guven-internal-net:
    driver: bridge

volumes:
  mssql_data: